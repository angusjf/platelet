<!doctype html>
<html>
    <head>
        <title>platelet - playground</title>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
        <style>
            :root {
                font-family: sans-serif;
            }

            body {
                margin: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }

            html body .codeflask__flatten {
                font-size: 1rem;
            }
            body .codeflask {
                background: transparent;
            }

            iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

            .editors {
                flex-grow: 1;
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                grid-auto-flow: column;
                gap: 1rem;
                padding: 1rem;
            }

            .editor {
                position: relative;
                border: 2px dashed lightgrey;
            }

            .tabs {
                display: flex;
                flex-direction: column;
            }

            .editor[role="tabpanel"] {
                flex-grow: 1;
            }

            [role="tablist"] button {
                appearance: none;
                font-size: 1rem;
                border: 2px solid lightgrey;
                border-bottom: none;
                background-color: white;
            }

            [aria-selected="true"] {
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <main class="editors">
            <div id="html-editors" class="tabs">
                <div role="tablist">
                    <button role="tab" onclick="tabClick(this)" aria-selected="true">index.html</button>
                    <button role="tab" onclick="tabClick(this)" aria-selected="false">blogpost.html</button>
                    <template id="new-tab">
                        <button role="tab" onclick="tabClick(this)" aria-selected="false">unnamed.html</button>
                    </template>
                    <button onclick="newTab()">+</button>
                </div>
                <div role="tabpanel" class="editor"></div>
                <div role="tabpanel" class="editor" hidden></div>
                <template id="new-tabpanel">
                    <div role="tabpanel" class="editor" hidden></div>
                </template>
            </div>
            <div id="json-editor" class="editor"></div>
            <div id="html-output" class="editor"></div>
            <div class="editor">
                <iframe sandbox id="rendered-output"></iframe>
            </div>
        </main>
        <script type="importmap">
            {
                "_imports": {
                    "codeflask": "https://cdn.jsdelivr.net/npm/codeflask@1.4.1/+esm",
                    "platelet": "/platelet/pkg/platelet_web.js"
                },
                "imports": {
                    "codeflask": "http://localhost:8000/playground/codeflask.module.js",
                    "platelet": "http://localhost:8000/pkg/platelet_web.js"
                }
            }
        </script>
        <script type="module">
            import CodeFlask from "codeflask";
            import init, { render_files } from "platelet";

            const htmlEditors = [...document.querySelectorAll("#html-editors .editor")].map((e, i) => ({
                title: document.querySelectorAll("#html-editors [role=tablist] [role=tab]")[i].innerText,
                editor: new CodeFlask(e, {
                    language: "html",
                }),
            }));

            const jsonEditor = new CodeFlask("#json-editor", {
                language: "javascript",
            });
            const htmlOutput = new CodeFlask("#html-output", {
                language: "html",
                readonly: true,
            });

            const renderedOutput = document.getElementById("rendered-output");

            htmlEditors[0].editor.updateCode(`<!doctype html>
<html>
  <head>
    <title>{{ title }}</title>
    <style> body {font-family: sans-serif}; </style>
  </head>
  <body>
    <slot pl-for="b in blogposts" pl-src="blogpost.html" ^blogpost="b">
    </slot>
  </body>
</html>`);

            htmlEditors[1].editor.updateCode(`<article>
  <img ^src="blogpost.img_url">
  <div>
    <h2>
      <a ^href="blogpost.link" target="_blank">{{blogpost.title}}</a>
    </h2>
    <template pl-html="blogpost.summary"></template>
    <date>{{blogpost.date}}</date>
  </div>
</article>
<style>
  article {
    display: flex;
    gap: 1rem;
    font-family: sans-serif;
  }
</style>`);

            jsonEditor.updateCode(
                JSON.stringify(
                    {
                        title: "Welcome to platelet",
                        blogposts: [
                            {
                                img_url: "https://angusjf.com/images/cy_1x.jpg",
                                link: "https://angusjf.com/platelet",
                                summary: "<p><i>in my opinion</i>, it's <b>pretty good</b></p>",
                                title: "Platelet",
                                date: "01/11/2025",
                            },
                            {
                                img_url: "https://angusjf.com/images/hanzi_1x.webp",
                                link: "https://angusjf.com",
                                summary: "<p>here's my real blog</p>",
                                title: "SOMETHING ELSE",
                                date: "01/11/2020",
                            },
                        ],
                    },
                    undefined,
                    4,
                ),
            );
            htmlOutput.updateCode(`loading...`);

            async function hookUp() {
                await init();

                htmlEditors.map((e) => e.editor.onUpdate(() => refreshOutput()));

                jsonEditor.onUpdate(() => refreshOutput());

                refreshOutput();
            }

            function refreshOutput() {
                try {
                    let files = {};
                    for (let i = 0; i < htmlEditors.length; i++) {
                        files[htmlEditors[i].title] = htmlEditors[i].editor.code;
                    }
                    let result = render_files(htmlEditors[0].title, JSON.stringify(files), jsonEditor.code);
                    htmlOutput.updateCode(result);
                    renderedOutput.srcdoc = result;
                } catch (e) {
                    console.error(e);
                    htmlOutput.updateCode(e.toString());
                    renderedOutput.srcdoc = "";
                }
            }

            hookUp();

            globalThis.tabClick = (e) => {
                [...document.querySelectorAll("[aria-selected=true]")].forEach((e) => (e.ariaSelected = false));
                e.ariaSelected = true;
                const tablist = e.closest("[role=tablist]");
                let index = [...tablist.children].indexOf(e);
                let tabpanels = [...tablist.parentNode.querySelectorAll("[role=tabpanel]")];
                tabpanels.forEach((tabpanel, i) => {
                    tabpanel.hidden = i != index;
                });
            };

            const lastMatch = (q) => [...document.querySelectorAll(q)].at(-1);

            globalThis.newTab = () => {
                let t = document.getElementById("new-tab").content.cloneNode(true);
                lastMatch("#html-editors [role=tab]").after(t);
                t = lastMatch("#html-editors [role=tab]");
                let tp = document.getElementById("new-tabpanel").content.cloneNode(true);
                lastMatch("#html-editors [role=tabpanel]").after(tp);
                tp = lastMatch("#html-editors [role=tabpanel]");
                const editor = new CodeFlask(tp, {
                    language: "html",
                });
                editor.onUpdate(() => refreshOutput());
                editor.updateCode("<!-- your code here -->");
                t.innerText = nextTabTitle("new.html");
                tabClick(t);
                htmlEditors.push({
                    title: t.innerText,
                    editor,
                });
            };

            function nextTabTitle(desired) {
                let titles = [...document.querySelectorAll("#html-editors [role=tab]")].map((e) => e.innerText);

                while (titles.includes(desired)) {
                    desired = "new-" + desired;
                }

                return desired;
            }
        </script>
    </body>
</html>
